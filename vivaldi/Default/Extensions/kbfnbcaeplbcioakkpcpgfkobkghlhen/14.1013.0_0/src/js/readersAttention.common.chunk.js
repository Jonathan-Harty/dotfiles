(self.webpackChunk=self.webpackChunk||[]).push([[9923],{75003:(e,t,i)=>{i.d(t,{a:()=>s,D:()=>g});var s,n=i(14601),a=i(90361),r=i(78674),o=i(85985),h=i(38983);!function(e){let t,i,s,n;!function(e){e.default="default",e.emogenie="emogenie",e.readersAttention="readersAttention",e.readersAttentionHelp="readersAttentionHelp",e.feedback="feedback",e.settings="settings",e.proofitRequest="proofitRequest",e.proofitReview="proofitReview",e.popup="popup"}(t=e.Type||(e.Type={})),function(e){e.importanceSurvey="importanceSurvey"}(i=e.PopupType||(e.PopupType={})),e.hasAlerts=function(e){switch(e.type){case t.default:case t.emogenie:case t.readersAttention:return!0;default:return!1}},function(e){let t;!function(e){let t;!function(e){e.inlineCard="inlineCard",e.predictionWidget="predictionWidget",e.navigation="navigation"}(t=e.Type||(e.Type={}))}(t=e.Caller||(e.Caller={}))}(s=e.ReadersAttention||(e.ReadersAttention={})),function(e){let t;!function(e){e.headerButton="headerButton",e.descriptionLink="descriptionLink"}(t=e.Caller||(e.Caller={}))}(n=e.ReadersAttentionHelp||(e.ReadersAttentionHelp={})),e.isReadersAttention=function(t){return t.type===e.Type.readersAttention},e.isReadersAttentionHelp=function(t){return t.type===e.Type.readersAttentionHelp}}(s||(s={}));class g{constructor(e,t,i,g,c){this.csActions=e,this.gnar=t,this.selectedHighlightsTracker=i,this.isTextFieldEmpty=g,this.browser=c,this.activeView=h.h.create({type:s.Type.default}),this._sub=new n.w,this._viewHistory=[],this.isHeaderNavigationEnabled=this.activeView.view((e=>e.type!==s.Type.feedback)),this._sub.add(this.activeView.subscribe((t=>{switch(t.type){case s.Type.emogenie:return void e.setHideWelcomeEmogenieNotification();case s.Type.settings:return void this.gnar.assistantSettingsShow();case s.Type.proofitRequest:return void this.gnar.proofitRequestFormShow();default:return}}))),this._sub.add(i.subscribe((e=>{if(e.length>0)for(;!s.hasAlerts(this.activeView.get());)this.popActiveView()}))),this._sub.add(g.pipe(r.b(100),o.h(a.fQ)).subscribe((()=>{if(this.activeView.get().type===s.Type.emogenie||this.activeView.get().type===s.Type.readersAttention)for(;this.activeView.get().type!==s.Type.default;)this.popActiveView()})))}pushActiveView(e){const t=this.activeView.get();e.type!==t.type&&(this._viewHistory.push(t),this.activeView.set(e))}popActiveView(){const e=this._viewHistory.pop()||{type:s.Type.default};e.type===s.Type.readersAttention&&(e.caller={type:s.ReadersAttention.Caller.Type.navigation}),this.activeView.set(e)}replaceActiveView(e){e.type!==this.activeView.get().type&&this.activeView.set(e)}get lastView(){return this._viewHistory[this._viewHistory.length-1]||{type:s.Type.default}}dispose(){this._sub.unsubscribe()}}},77869:(e,t,i)=>{i.r(t),i.d(t,{ReadersAttentionFeature:()=>ue,getLogName:()=>pe});var s=i(8482),n=i(24448),a=i(97757),r=i(14601),o=i(32952),h=i(5114),g=i(38983),c=i(40327),l=i(75003),d=i(90361),p=i(15646),u=i(83078);function _(e){switch(e){case l.a.ReadersAttention.Caller.Type.inlineCard:return"inlineCard";case l.a.ReadersAttention.Caller.Type.predictionWidget:return"predictionWidget";case l.a.ReadersAttention.Caller.Type.navigation:return"navigation";default:(0,d.vE)(e)}}class m{constructor(e,t,i,s){this._gnar=e,this._statistics=t,this._getTextScore=i,this._getAlertById=s,this._statsOnOpen=h.none}_getLaunchSourceLabel(e,t){switch(e.type){case l.a.ReadersAttention.Caller.Type.inlineCard:return(0,c.pipe)(this._getAlertById(e.alertId),h.filter((e=>e.isTakeaway)),h.fold((()=>""),(e=>e._legacyAlert.title||"")));case l.a.ReadersAttention.Caller.Type.predictionWidget:return t;case l.a.ReadersAttention.Caller.Type.navigation:return"";default:(0,d.vE)(e)}}_getBasicOpenMetrics(e,t){return{textScore:this._getTextScore(),numWords:this._statistics.wordsCount.get(),alertCounts:this._statistics.alertCounts.get(),launchSource:_(t.type),launchSourceLabel:this._getLaunchSourceLabel(t,e)}}onOpen(e,t,i,s){(0,c.pipe)(this._statsOnOpen,h.fold((()=>h.some({...this._getBasicOpenMetrics(t,s),numCards:i,checklist:e,time:performance.now(),numParagraphs:this._statistics.paragraphsCount.get(),numFormattingSpans:this._statistics.formattingSpansCount.get()})),(()=>h.none)),u.tap((e=>{const t=e.alertCounts.expandedViewSupported,s=e.alertCounts.freeClarity,n=e.alertCounts.critical,a=e.alertCounts.filter((e=>"priority"===e.assistantView)).expandedViewSupported,r=e.checklist.filter((e=>e.checked)).length;this._gnar.attentionPanelShow(Array.from(e.checklist),e.launchSource,e.launchSourceLabel,t,s,n,r,i.takeaway,a,i.nonTakeaway,e.numWords,e.textScore),this._statsOnOpen=h.some(e)})))}onClose(e,t){(0,c.pipe)(this._statsOnOpen,u.tap((i=>{const s=performance.now()-i.time,n=i.checklist.filter((e=>e.checked)).length,a=e.filter((e=>e.checked)).length;this._gnar.attentionPanelHide(Array.from(e),Array.from(i.checklist),this._statistics.wordsCount.get(),this._getTextScore(),i.numWords,i.textScore,i.launchSource,i.launchSourceLabel,this._statistics.formattingSpansCount.get(),i.numFormattingSpans,a,n,t.takeaway,i.numCards.takeaway,this._statistics.paragraphsCount.get(),i.numParagraphs,t.nonTakeaway,i.numCards.nonTakeaway,s),this._statsOnOpen=h.none})))}onHelpScreenShow(e){this._gnar.attentionHelpScreenShow(e)}onTakeawayUserAction(e,t,i,s){switch(i.type){case p.lY.Type.takeawayCorrectlyDetected:return this._gnar.attentionKeyTakeawayFeedbackClick(s.end,s.start,t,"up");case p.lY.Type.takeawayIncorrectlyDetected:return this._gnar.attentionKeyTakeawayFeedbackClick(s.end,s.start,t,"down");case p.lY.Type.takeawayDismiss:return this._gnar.attentionKeyTakeawayIgnored(e,s.end,s.start,t);case p.lY.Type.takeawayResolve:return this._gnar.attentionKeyTakeawayAcknowledged(e,s.end,s.start,t);default:(0,d.vE)(i)}}onKeyTakeawayCardShow(e,t){this._gnar.attentionKeyTakeawayCardShow(t.end,t.start,e)}onChecklistItemExpand(e){this._gnar.attentionChecklistItemExpand(e.checked,e.id,e.numAlerts,e.title)}}var f,v,y,w=i(76974),x=i(66310),R=i(77176),b=i(28043),C=i(93508),I=i(85985);!function(e){e.emptyLinesRegex=/([\t ]*\r*\n){2,}/,e.lineBreakRegex=/([\t ]*\r*\n){1,}/,e.split=function({start:t,end:i},s,n=e.emptyLinesRegex){var a;const r=[];if(!n.test(s.slice(t,i)))return[];let o=t;for(;;){const e=s.slice(o,i).match(n),t=null!==(a=null==e?void 0:e.index)&&void 0!==a?a:i-o;if(o!==o+t&&r.push({start:o,end:o+t}),!e)break;o+=t+e[0].length}return r},e.isFormattingChange=function(e){return 0===e.changes.length&&!e.deltaChange.isEmpty}}(f||(f={})),function(e){e.lerp=function(e,t,i){return(1-i)*e+i*t},e.mean=function(e){return e.reduce(((e,t)=>e+t),0)/e.length}}(v||(v={})),function(e){e.lerp=function(e,t){return v.lerp(e[0],e[1],t)},e.approxEqual=function(e,t,i=.001){return Math.abs(e[0]-t[0])<i&&Math.abs(e[1]-t[1])<i},e.getAverage=function(e){const t=e.reduce(((e,t)=>e+(t.range.end-t.range.start)),0);return e.reduce(((e,i)=>e+(i.intensity[0]+i.intensity[1])/2*(i.range.end-i.range.start)/t),0)},e.constant=function(e){return[e,e]},e.linear=function(e,t){return[e,t]},e.toColors=function(e){const t=e=>`rgba(135, 232, 209, ${e.toFixed(2)})`,i=function([e,t]){const i=e=>Math.max(Math.min(e,1),0),[s,n]=[0,1];return{start:v.lerp(s,n,i(e)),end:v.lerp(s,n,i(t))}}(e);return[t(i.start),t(i.end)]}}(y||(y={}));var M,k=i(36991),S=i(71249);!function(e){let t,i;!function(e){let t;!function(e){e.fromCapi=function(e){return`${e}`},e.toCapi=function(e){return Number(e)},e.create=function(e){return void 0===e?`${d.iy.create().slice(0,6)}`:e}}(t=e.Id||(e.Id={})),e.fromCapi=function(e=[0,0]){return i=>({id:t.fromCapi(i.id),range:{start:i.begin,end:i.end},intensity:i.intensities||e,text:i.text})}}(t=e.Range||(e.Range={})),function(e){let t;!function(e){e[e.v3=3]="v3"}(t=e.Version||(e.Version={}))}(i=e.Capi||(e.Capi={}))}(M||(M={}));class T{constructor(e,t,i,s,n=M.Range.Id.create){this._getClosestRangeToPosition=e,this._getIntersectingRanges=t,this._getLastRevisionSent=i,this._getText=s,this._nextRangeId=n}pushChanges(e,t){var i;const n=(i=e.delta,k.s.normalizeDelta(i).ops.reduce(((e,t)=>{var i;return k.s.isRetain(t)?e.index+=t.retain:k.s.isDelete(t)||k.s.isInsertString(t)&&(e.insertions.push({text:t.insert.trim(),pos:e.index+((null===(i=t.insert.match(/^\s+/))||void 0===i?void 0:i[0].length)||0)}),e.index+=t.insert.length),e}),{index:0,insertions:[]}).insertions.filter((e=>""!==e.text))).filter((e=>!t.resized.find((t=>s.SV.intersects(t.range,{start:e.pos,end:e.pos+e.text.length})))));return S.compact(n.map((e=>this._highlight(e))))}_highlight(e){const t=this._getText(),i=h.toNullable(this._getClosestRangeToPosition(e.pos,(t=>t.range.start<e.pos))),s=!i&&e.pos>0&&""!==t.slice(0,e.pos).trim()||i&&""!==t.slice(i.range.end,e.pos).trim(),n=i&&!t.slice(i.range.end,e.pos).includes("\n");if(s)return h.none;if(i&&n)return h.some(this._highlightInsertionWithRangeOnLeftSide(e,i));const a=h.toNullable(this._getClosestRangeToPosition(e.pos,(t=>t.range.start>=e.pos+e.text.length))),r=a&&!t.slice(e.pos+e.text.length,a.range.start).includes("\n");return a&&r?h.some(this._highlightInsertionWithRangeOnRightSide(e,a)):this._highlightStandaloneInsertion(e)}_highlightInsertionWithRangeOnLeftSide(e,t){const i=A(t,this._getLastRevisionSent());return{id:i?t.id:this._nextRangeId(),range:{start:i?t.range.start:Math.max(t.range.end,e.pos),end:e.pos+e.text.length},intensity:i?t.intensity:y.constant(t.intensity[1])}}_highlightInsertionWithRangeOnRightSide(e,t){const i=A(t,this._getLastRevisionSent());return{id:i?t.id:this._nextRangeId(),range:{start:e.pos,end:i?t.range.end:Math.min(t.range.start,e.pos+e.text.length)},intensity:i?t.intensity:y.constant(t.intensity[0])}}_highlightStandaloneInsertion(e){const t={start:e.pos,end:e.pos+e.text.length};return(0,c.pipe)(this._getIntensityForNewInsertion(t),h.map((i=>({id:this._nextRangeId(),range:t,intensity:i,text:e.text}))))}_getIntensityForNewInsertion(e){const t=f.split({start:0,end:e.start},this._getText(),f.lineBreakRegex),i=f.split({start:e.end,end:this._getText().length},this._getText(),f.lineBreakRegex),s=t.length>0?t[t.length-1]:null,n=i.length>0?i[0]:null;if(s&&n){const e=this._getAverageIntensityOver(s),t=this._getAverageIntensityOver(n);return h.some(y.linear(e,t))}if(s){const e=this._getAverageIntensityOver(s);return h.some(y.constant(e))}if(n){const e=this._getAverageIntensityOver(n);return h.some(y.constant(e))}return h.none}_getAverageIntensityOver(e){const t=this._getIntersectingRanges(e);return y.getAverage(t.map((e=>({range:{start:e.range.start,end:e.range.end},intensity:e.intensity}))))}}function A(e,t){return h.isSome(e.localInfo)&&u.unsafeGet(e.localInfo).lastRevision===t}var F=i(55073),L=i(74850),B=i(25938),E=i(64450);class ${constructor(e){this._text=e,this._log=L.Y.create(pe($.name)),this._changes=[]}registerRevision(e){this._changes.push({delta:B.RI.delta(new E.Delta,this._text.length),textBeforeChange:this._text,revision:e}),this._log.info(`registered revision ${e}`)}revisionFinished(e){const t=this._changes.findIndex((t=>t.revision===e));if(t<0)return this._log.info(`revision ${e} finished -- not found`),[];const i=this._changes.splice(0,t+1).map((e=>e.revision));return this._log.info(`revision ${e} finished -- dropped [${i.join(", ")}]`),i}getChangesSinceRevision(e){const t=this._changes.findIndex((t=>t.revision===e));if(t<0)return this._log.warn(`revision ${e} not found in history`),h.none;const i=this._changes.slice(t).map((e=>e.delta)),s=i.slice(1).reduce(((e,t)=>e.compose(t)),i[0]);return s.isEmpty?h.none:h.some({textBeforeChanges:this._changes[t].textBeforeChange,delta:s})}pushChanges(e){if(e.isEmpty)return;if(this._text=(0,F.l)(e.delta,this._text),0===this._changes.length)return;const t=this._changes[this._changes.length-1];t.delta=t.delta.compose(e)}get text(){return this._text}}var O,H=i(76331),P=i(34311),V=i(62337);!function(e){e.stitchAdjacent=function(e,t=1,i=.5,s=.5){const n=function(e,t=.5){const i=e.length>0?[{rects:[e[0]],top:e[0].rect.top,bottom:e[0].rect.top+e[0].rect.height}]:[];for(let s=1;s<e.length;++s){const n=i[i.length-1],a=e[s].rect;n.bottom-a.top>=t*Math.min(n.bottom-n.top,a.height)?(n.rects.push(e[s]),n.top=a.top<n.top?a.top:n.top,n.bottom=a.top+a.height>n.bottom?a.top+a.height:n.bottom):i.push({rects:[e[s]],top:a.top,bottom:a.top+a.height})}return i}(e,s);for(let e=0;e<n.length;++e){if(e>0){const t=n[e].top-n[e-1].bottom,s=n[e].bottom-n[e].top,a=n[e-1].bottom-n[e-1].top;t<Math.min(s,a)*i&&(n[e].top=n[e-1].bottom)}if(e<n.length-1){const t=n[e+1].top-n[e].bottom,s=n[e].bottom-n[e].top,a=n[e+1].bottom-n[e+1].top,r=.5*t;t<Math.min(s,a)*i&&(n[e].bottom=n[e].bottom+r)}for(let t=0;t<n[e].rects.length;++t)n[e].rects[t].rect={...n[e].rects[t].rect,top:n[e].top,height:n[e].bottom-n[e].top};for(let i=1;i<n[e].rects.length;++i){const s=n[e].rects[i-1].rect.left+n[e].rects[i-1].rect.width,a=n[e].rects[i].rect.left-s,r=.5*a;a>0&&a<Math.min(n[e].rects[i].rect.height,n[e].rects[i-1].rect.height)*t&&(n[e].rects[i-1].rect={...n[e].rects[i-1].rect,width:n[e].rects[i-1].rect.width+r},n[e].rects[i].rect={...n[e].rects[i].rect,left:s+r,width:n[e].rects[i].rect.left+n[e].rects[i].rect.width-s-r})}}return n.flatMap((e=>e.rects))},e.getMinDistanceBetween=function(e,t){if(V.UL.intersects(e,t))return 0;const i=e.left+e.width<t.left,s=e.top>t.top+t.height,n=e.left>t.left+t.width,a=e.top+e.height<t.top;return(i||n)&&(a||s)?1/0:i?t.left-(e.left+e.width):n?e.left-(t.left+t.width):a?t.top-(e.top+e.height):e.top-(t.top+t.height)},e.getBoundingBox=function(e){return e.slice(1).reduce(((e,t)=>{const i=Math.min(t.top,e.top),s=Math.min(t.left,e.left);return{top:i,left:s,width:Math.max(e.left+e.width,t.left+t.width)-s,height:Math.max(e.top+e.height,t.top+t.height)-i}}),e[0])}}(O||(O={}));class Q{constructor(e,t,i,s,n,a){this._geometryProvider=e,this._geometryLayout=t,this._textFieldRectInvalidated=i,this._formattingChanged=s,this._getTextMap=n,this.heatmapChanges=a,this._highlightsCollection=new H.C(this._geometryProvider,this._geometryLayout,this._getTextMap,P.qH.everything,this._textFieldRectInvalidated,void 0,void 0,void 0,void 0,L.Y.create(pe(Q.name))),this._sub=new r.w,this.geometry=this._highlightsCollection.geometry.view(N),this._sub.add(a.subscribe((e=>this._onRangeChanges(e)))),this._sub.add(this._formattingChanged.subscribe((e=>{this._highlightsCollection.maintainConsistency([],(e=>e),!0)})))}_onRangeChanges(e){this._highlightsCollection.removeHighlights(e.removed.map(P.y$.Id.createFromMark)),"update"===e._tag&&(e.changed.forEach((e=>{this._highlightsCollection.updateHighlight(P.y$.Id.createFromMark(e.id),e.range,{intensity:e.intensity,range:e.range,isLocal:h.isSome(e.localInfo)})})),this._highlightsCollection.maintainConsistency(e.changed.map((e=>P.y$.Id.createFromMark(e.id)))))}dispose(){this._sub.unsubscribe(),this._highlightsCollection.dispose()}}function N(e){const t=function(e){const t=e.map((e=>({...e,boundingBox:O.getBoundingBox(e.rects)}))),i=[...t.slice(0,1).map((e=>({ranges:[e],boundingBox:e.boundingBox})))];for(const e of t.slice(1)){let t=!1;const s=1*v.mean(e.rects.map((e=>e.height)));for(let n=i.length-1;n>=0;--n){const a=i[n];if(O.getMinDistanceBetween(a.boundingBox,e.boundingBox)<=s&&a.ranges.some((t=>O.getMinDistanceBetween(t.boundingBox,e.boundingBox)<=s))){t=!0,a.boundingBox=O.getBoundingBox([a.boundingBox,e.boundingBox]),a.ranges.push(e);break}}t||i.push({ranges:[e],boundingBox:e.boundingBox})}return i.map((e=>e.ranges))}([...e.entries()].filter((e=>!!e[1])).map((([e,{rects:t,meta:{range:i,isLocal:s}}])=>({id:M.Range.Id.create(e),range:i,rects:t,isLocal:s}))).sort(((e,t)=>e.range.start-t.range.start))).map(((e,t)=>e.flatMap((({id:e,rects:i,isLocal:s})=>i.map((i=>({id:e,rect:i,groupIdx:t,isLocal:s}))))).map(((e,t)=>({...e,rectIdx:t}))))).flatMap((e=>O.stitchAdjacent(e))).reduce(((e,{id:t,rect:i,rectIdx:s,groupIdx:n,isLocal:a})=>{var r;return e.has(t)?null===(r=e.get(t))||void 0===r||r.rects.push({...i,rectIdx:s}):e.set(t,{id:t,rects:[{...i,rectIdx:s}],intensities:[],groupIdx:n,isLocal:a}),e}),new Map);for(const[i,s]of t.entries())s.intensities=W(e.get(P.y$.Id.createFromMark(i)).meta.intensity,s.rects);return t}function W(e,t){const[i,s]=e,n=(s-i)/t.reduce(((e,t)=>e+t.width),0),a=[];let r=i;for(const e of t){const t=e.width*n;a.push([r,r+t]),r+=t}return t.length>0&&(a[a.length-1][1]=s),a}var j=i(57050),D=i(64015),Y=i(17889),q=i(51996),z=i(55360);function K({start:e,end:t,meta:{id:i,intensity:s,localInfo:n}}){return{id:i,range:{start:e,end:t},intensity:s,localInfo:n}}class U{constructor(e,t,i,s,n=M.Range.Id.create){this._changesQueue=e,this._rangePositionManager=t,this._localRangeManager=i,this._changesHighlighter=s,this._nextLocalRangeId=n,this._log=L.Y.create(pe(U.name)),this._changes=new o.xQ,this._debug=!1,this.changes=this._changes.asObservable()}get empty(){return this._rangePositionManager.empty}getAllRanges(){return this._rangePositionManager.getAll()}clear(){const e=this._rangePositionManager.clear();this._localRangeManager.clear(),this._log.debug(`clearing heatmap ranges [${e.join(", ")}]`),this._changes.next({_tag:"remove",removed:e})}registerRevision(e){this._changesQueue.registerRevision(e),this._localRangeManager.registerRevision(e)}revisionFinished(e){this._changesQueue.revisionFinished(e);const t=this._localRangeManager.clearRangesRegisteredBeforeRevision(e);t.length>0&&(t.forEach((e=>this._deleteRange(e))),this._changes.next({removed:t,_tag:"remove"}))}onHeatmapMessage(e,t){const i=this._changesQueue.getChangesSinceRevision(t);this._log.debug(`received heatmap for revision ${t} - ${h.fold((()=>"no local changes"),(e=>`local changes ${JSON.stringify(e.delta.delta.ops)}`))(i)}`,e);const s=[],n=[];e.remove.map(M.Range.Id.fromCapi).forEach((e=>{this._deleteRange(e),s.push(e)}));for(const a of e.add.concat(e.update)){if(""===a.text.trim()){this._log.warn(`invalid range #${a.id}, text = [${a.text}] -- dropping`);continue}const e=(0,c.pipe)(i,h.fold((()=>({start:a.begin,end:a.end})),(e=>G({start:a.begin,end:a.end},e.delta))));this._clearLocalRangesIntersecting(e).forEach((e=>{s.push(e)}));const r=M.Range.Id.fromCapi(a.id),o=a.intensities||(0,c.pipe)(this._rangePositionManager.getById(r),h.chain((e=>e.intensity?h.some(e.intensity):h.none)),h.getOrElse((()=>[0,0]))),g={id:r,range:e,intensity:o};(0,c.pipe)((0,Y.nI)(J(this._changesQueue.text,g,this._nextLocalRangeId)),h.fold((()=>{this._setRange(g,t,!1),n.push({...g,localInfo:h.none})}),(e=>{this._deleteRange(r),s.push(r),e.forEach((e=>{this._setRange(e,t,!0),n.push({...e,localInfo:h.some({lastRevision:t})})}))})))}n.length>0?this._changes.next({changed:n,removed:s,_tag:"update"}):s.length>0&&this._changes.next({removed:s,_tag:"remove"})}pushChanges(e){this._debug&&this._log.trace(`processing text changes ${JSON.stringify(e.delta.ops)}`),this._changesQueue.pushChanges(e),(0,c.pipe)(this._rangePositionManager.pushChanges(e),u.tap((t=>this._onTextChanges(e,t))))}_onTextChanges(e,t){const i=new Set,s=new Map;this._changesHighlighter.pushChanges(e,t).flatMap((e=>(0,c.pipe)((0,Y.nI)(J(this._changesQueue.text,e,this._nextLocalRangeId)),h.fold((()=>[e]),D.qo)))).forEach((e=>{this._setRange(e,this._localRangeManager.lastRevisionSent,!0),s.set(e.id,{...e,localInfo:h.some({lastRevision:this._localRangeManager.lastRevisionSent})})})),t.collapsed.forEach((e=>{this._deleteRange(e.id),i.add(e.id)})),t.resized.forEach((e=>{(0,c.pipe)((0,Y.nI)(J(this._changesQueue.text,e,this._nextLocalRangeId)),h.fold((()=>{s.set(e.id,{...e,localInfo:e.localInfo})}),(t=>{this._deleteRange(e.id),i.add(e.id),t.forEach((e=>{this._setRange(e,this._localRangeManager.lastRevisionSent,!0),s.set(e.id,{...e,localInfo:h.some({lastRevision:this._localRangeManager.lastRevisionSent})})}))})))})),t.shifted.filter((e=>!s.has(e.id))).forEach((e=>s.set(e.id,{...e,localInfo:e.localInfo})));const n={changed:Array.from(s.values()),removed:Array.from(i)};this._debug&&this._log.debug("processed text changes",{...n,ops:JSON.stringify(e.delta.ops)}),n.changed.length>0?this._changes.next({...n,_tag:"update"}):n.removed.length>0&&this._changes.next({removed:n.removed,_tag:"remove"})}_clearLocalRangesIntersecting(e){const t=this._localRangeManager.clearIntersectingRanges(e,(0,j.flow)((e=>this._rangePositionManager.getById(e)),h.map((e=>e.range))));return t.forEach((e=>{this._deleteRange(e),this._log.trace("removed intersecting range",e)})),t}_deleteRange(e){this._rangePositionManager.remove(e)||this._log.debug(`range #${e} already removed`)}_setRange({id:e,range:t,intensity:i},n,a){a&&this._localRangeManager.registerRange(e);const r={start:0,end:this._changesQueue.text.length};s.SV.contains(r,t)||this._log.warn(`range #${e} [${t.start}-${t.end}] is out of bounds: ${s.SV.toString(t)} vs ${s.SV.toString(r)}`),this._rangePositionManager.set(e,t,{intensity:i,localInfo:a?h.some({lastRevision:n}):h.none})}}function J(e,{range:{start:t,end:i},intensity:s},n){return f.split({start:t,end:i},e).map((e=>({id:n(),range:e,intensity:y.linear(v.lerp(s[0],s[1],(e.start-t)/(i-t)),v.lerp(s[0],s[1],(e.end-t)/(i-t)))})))}function G(e,t){const{changed:i}=(0,z.wb)(t,[q.SV.create(e.start,e.end)]);return(0,c.pipe)(S.head(i),h.fold((()=>e),j.identity),(e=>({start:e.start,end:e.end})))}class X{constructor(){this._log=L.Y.create(pe(X.name)),this._revisionsQueue=[],this.clear()}get lastRevisionSent(){return(0,c.pipe)(S.last(this._revisionsQueue),h.chain((e=>e.revision)),h.getOrElse((()=>"no-rev")))}clear(){this._revisionsQueue=[{revision:h.none,ids:new Set}]}registerRange(e){(0,c.pipe)(S.last(this._revisionsQueue),u.tap((t=>{t.ids.add(e)})))}registerRevision(e){this._revisionsQueue.push({revision:h.some(e),ids:new Set})}clearRangesRegisteredBeforeRevision(e){return(0,c.pipe)(this._revisionsQueue,S.findLastIndex((t=>h.isSome(t.revision)&&t.revision.value===e)),h.map((e=>{if(e>0){return this._revisionsQueue.splice(0,e).flatMap((e=>[...e.ids]))}return[]})),u.tap((t=>{const i=[...t];i.length>0&&this._log.trace(`clearing local ranges inserted before ${e} - [${i.join(", ").slice(0,100)}]`)})),h.getOrElse((()=>[])))}clearIntersectingRanges(e,t){const i=[];return this._revisionsQueue.forEach((n=>{n.ids.forEach((a=>(0,c.pipe)(t(a),h.chain(h.fromPredicate((t=>s.SV.intersects(e,{start:t.start,end:t.end})))),u.tap((()=>{i.push(a),n.ids.delete(a)})))))})),i}}class Z{constructor(e,t){this._transformRange=t,this._log=L.Y.create(pe(Z.name)),this._positionManager=new z.Xr,this._positionManager.pushChanges(B.RI.resFromText(e))}get empty(){return 0===this._positionManager.getRegisteredRanges().length}getAll(){return this._positionManager.getRegisteredRanges().map(this._transformRange)}getById(e){return(0,c.pipe)(h.tryCatch((()=>this._positionManager.getRange(e))),h.map(this._transformRange))}set(e,t,i){h.tryCatch((()=>this._positionManager.deregisterRange(e))),h.tryCatch((()=>this._positionManager.registerRange(e,q.SV.create(t.start,t.end,{...i,_range:t}))))}remove(e){return(0,c.pipe)(h.tryCatch((()=>this._positionManager.deregisterRange(e))),h.fold((()=>!1),(()=>!0)))}clear(){return(0,c.pipe)(this._positionManager.getRegisteredRanges(),S.map((e=>e.meta.id)),S.map((e=>this.remove(e)?h.some(e):h.none)),S.compact)}findClosestToPosition(e,t){return(0,c.pipe)(this._positionManager.findClosestToPosition(e,(0,j.flow)(this._transformRange,t)),h.map(this._transformRange))}findIntersection(e){return this._positionManager.findIntersections(q.SV.create(e.start,e.end)).map(this._transformRange)}pushChanges(e){if(e.isEmpty)return this._log.debug("processed text changes: NO OP"),h.none;const t=this._positionManager.pushChanges(e).changed,i=t.filter((e=>e.meta._range.end-e.meta._range.start!=e.end-e.start&&e.end!==e.start)),s=t.filter((e=>e.meta._range.end===e.end&&e.meta._range.start===e.start&&e.end!==e.start)),n=t.filter((e=>e.meta._range.end-e.meta._range.start==e.end-e.start&&e.meta._range.start!==e.start&&e.end!==e.start)),a=t.filter((e=>e.end===e.start));return t.forEach((e=>{e.meta._range={start:e.start,end:e.end}})),h.some({affected:s.map(this._transformRange),resized:i.map(this._transformRange),shifted:n.map(this._transformRange),collapsed:a.map(this._transformRange)})}}class ee{constructor(e,t,i,s,n,a,o){this._initialText=e,this._textChanges=t,this._geometryInvalidated=i,this._geometryProvider=s,this._geometryLayout=n,this._heatmapVisible=a,this._connectionId=null,this._changesQueue=new $(this._initialText),this._rangePositionManager=new Z(this._initialText,K),this._localRangeManager=new X,this._changesHighlighter=new T(((e,t)=>this._rangePositionManager.findClosestToPosition(e,t)),(e=>this._rangePositionManager.findIntersection(e)),(()=>this._localRangeManager.lastRevisionSent),(()=>this._changesQueue.text)),this._processor=new U(this._changesQueue,this._rangePositionManager,this._localRangeManager,this._changesHighlighter),this._highlights=g.h.create(null),this._version=g.h.create(void 0),this._averageIntensity=g.h.create(0),this._sub=new r.w,this.heatmap=this._highlights.pipe((0,x.w)((e=>(null==e?void 0:e.geometry)||(0,w.of)(new Map))),(0,R.U)((e=>({highlights:e,version:this._version.get()})))),this.averageIntensity=this._averageIntensity.view(),this._sub.add(this._heatmapVisible.pipe((0,b.x)()).subscribe((e=>{var t;null===(t=this._highlights.get())||void 0===t||t.dispose(),e&&this._highlights.set(new Q(this._geometryProvider,this._geometryLayout,this._geometryInvalidated,this._textChanges.pipe(I.h((e=>f.isFormattingChange(e.textChanges)||e.textChanges.deltaChange.isEmpty)),R.U((e=>e.textMap))),o,this._processor.changes.pipe((0,C.O)({removed:[],changed:this._processor.getAllRanges(),textMap:o(),_tag:"update"}))))})))}onTextChanges(e){this._processor.pushChanges(e)}onFinished(e){this._processor.revisionFinished(e)}onNewRemoteRevision(e){this._processor.registerRevision(e)}onAttentionHeatmapMessage(e,t){t!==this._connectionId&&null!==this._connectionId&&this._processor.clear(),this._connectionId=t;const i=s.QT.create(t,e.rev);this._processor.onHeatmapMessage(e,i),this._averageIntensity.set(y.getAverage(this._processor.getAllRanges()))}dispose(){var e;null===(e=this._highlights.get())||void 0===e||e.dispose(),this._sub.unsubscribe()}}var te=i(27378),ie=i(5739),se=i(2844),ne=i(67521);const ae=({heatmap:e,size:t,style:i,className:s,felog:n,debug:a=!1})=>{const r=te.useRef(null);return(0,ne.A)((0,se.aj)(e,t,((e,{width:t,height:i})=>{const s=null==n?void 0:n.attentionHeatmap.renderTime.startMeasure(),o=r.current,h=null==o?void 0:o.getContext("2d");if(o&&h){o.width=t,o.height=i,h.clearRect(0,0,t,i);for(const t of e.highlights.values())t.rects.forEach(((e,i)=>{re(h,t,e,t.intensities[i],a)}));null==s||s.endMeasure()}else null==s||s.cancelMeasure()}))),te.createElement("canvas",{ref:r,style:i,className:s,"data-grammarly-part":"heatmap"})};function re(e,t,i,s,n){const[a,r]=y.toColors(s);if(a!==r){const t=e.createLinearGradient(i.left,0,i.left+i.width,0);t.addColorStop(0,a),t.addColorStop(1,r),e.fillStyle=t}else e.fillStyle=a;if(e.fillRect(i.left,i.top,i.width,i.height),n){e.strokeStyle="black",e.lineWidth=1,e.strokeRect(i.left,i.top,i.width,i.height);const s=`${t.id}-${t.groupIdx}-${i.rectIdx}`,n=12;e.font=`normal normal bold ${n}px Arial`,e.fillStyle="white",e.fillRect(i.left+1,i.top+i.height-1-n,Math.min(i.width,e.measureText(s).width),Math.min(i.height,n)),e.fillStyle="red",e.fillText(s,i.left+1,i.top+i.height-1)}}const oe=({heatmap:e,className:t,style:i,debug:s})=>te.createElement(ie.F.div,{className:t,style:i},e.pipe((0,R.U)((e=>Array.from(e.highlights.values()).flatMap((e=>e.rects.map(((t,i)=>({...t,intensity:e.intensities[i],id:`${e.id}-${i}`,highlightId:e.id,groupIdx:e.groupIdx,isLocal:e.isLocal}))))).map((e=>te.createElement("div",Object.assign({},s?{"data-highlight-id":e.highlightId,"data-group-idx":e.groupIdx,"data-rect-idx":e.rectIdx}:{},{key:e.id,style:{position:"absolute",width:e.width,height:e.height,left:e.left,top:e.top,background:he(e.intensity),...s?{border:"1px solid "+(e.isLocal?"red":"black")}:{}}}))))))));function he(e){const[t,i]=y.toColors(e);return`linear-gradient(to right, ${t}, ${i})`}var ge=i(23866);class ce{constructor(e,t,i,s,n){this._useHeatmapCanvas=e,this._service=t,this._visible=i,this._textFieldLayout=s,this._felog=n,this._debug=!1}get view(){return te.createElement(ie.F.Fragment,null,this._visible.view((e=>e?this._useHeatmapCanvas?te.createElement(ae,{debug:this._debug,felog:this._felog,heatmap:this._service.heatmap,size:this._textFieldLayout.scrollSize.behavior,className:ge.heatmap}):te.createElement(oe,{debug:this._debug,heatmap:this._service.heatmap,className:ge.heatmap}):null)))}}var le=i(84966);class de{constructor(){this._takeawaysFeedback=new Map,this._log=L.Y.create("TakeawayFeedbackStore")}registerFeedback(e,t){this._takeawaysFeedback.get(e)!==t&&(this._takeawaysFeedback.set(e,t),this._log.debug(`Feedback "${t}" stored for alert #${e}]`))}deleteFeedback(e){this._takeawaysFeedback.delete(e),this._log.debug(`Removed feedback for alert #${e}`)}get addFeedbackToRawAlertTransformer(){return e=>{if(le.wQ.isTakeaway(e)){const t=this._takeawaysFeedback.get(e.id);return t?{...e,extra_properties:{...e.extra_properties,takeawayFeedback:t}}:e}return e}}}function pe(e){return`ReadersAttn-${e}`}class ue{constructor(e,t,i,s,c,l,d,p,u,_){this._useHeatmapCanvas=e,this._textObserver=t,this._geometryInvalidated=i,this._geometryProvider=s,this._geometryLayout=c,this._textFieldLayout=l,this._getAlertById=d,this._gnar=p,this._felog=u,this._statistics=_,this._subs=new r.w,this.heatmapVisible=g.h.create(!1),this._heatmapReceived=g.h.create(!1),this._messages=g.h.create(h.none),this._rawChecklist=g.h.create({wordsCount:0,items:new Map}),this.rawChecklist=this._rawChecklist.view(),this.tracking=new m(this._gnar,this._statistics,(()=>this._heatmapService.averageIntensity.get()),(e=>this._getAlertById(e))),this._textChangesSubject=new o.xQ,this._revisionMeasures=new n.P(50),this._heatmapService=new ee(this._textObserver.getCurrentTextMap().getPlainText(),this._textChangesSubject,this._geometryInvalidated,this._geometryProvider,this._geometryLayout,this.heatmapVisible,(()=>this._textObserver.getCurrentTextMap())),this._heatmapController=new ce(this._useHeatmapCanvas,this._heatmapService,this.heatmapVisible,this._textFieldLayout,this._felog),this.takeawaysFeedbackStore=new de,this.heatmapView=this._heatmapController.view,this.heatmapReceived=this._heatmapReceived.view(),this.messages=this._messages.view(),this._subs.add(this._textObserver.contentChanges.immediate.subscribe((e=>this._textChangesSubject.next({textChanges:e,textMap:this._textObserver.getCurrentTextMap()})))),this._subs.add(this._textChangesSubject.pipe(a.d.measure(this._felog.attentionHeatmap.textChangeProcessingTime.measure)).subscribe((e=>{this._heatmapService.onTextChanges(e.textChanges.deltaChange)})))}get addFeedbackToRawAlertTransformer(){return this.takeawaysFeedbackStore.addFeedbackToRawAlertTransformer}onNewRemoteRevision(e){const t=this._revisionMeasures.enqueue({revision:e,measure:this._felog.attentionHeatmap.responseTime.startMeasure()});null==t||t.measure.cancelMeasure(),this._heatmapService.onNewRemoteRevision(e)}onAttentionHeatmapMessage(e,t){var i;this._heatmapReceived.set(!0);const n=s.QT.create(t,null!==(i=e.originalRev)&&void 0!==i?i:e.rev),a=this._revisionMeasures.toArray().find((e=>e.revision===n));a&&(this._revisionMeasures.delete(a),a.measure.endMeasure());const r=this._felog.attentionHeatmap.responseProcessingTime.startMeasure();this._heatmapService.onAttentionHeatmapMessage(e,t),r.endMeasure()}onAttentionInfoMessage(e){const t=new Map(this._rawChecklist.get().items);e.checklist.forEach((e=>t.set(e.id,e))),this._rawChecklist.set({wordsCount:e.wordsCount,items:t}),this._messages.set(h.some({headerMessage:e.headerMessage,predictionMessage:e.predictionMessage}))}onFinished(e){this._heatmapService.onFinished(e)}dispose(){this._subs.unsubscribe(),this._heatmapService.dispose()}}},23866:e=>{e.exports={heatmap:"_2rx7l",fadeIn:"_3nM-b"}}}]);